name: C Build and Test

on: [push, pull_request]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install system dependencies # Install any system dependencies
      run: sudo apt-get update && sudo apt-get install -y gcc make cmake

    - name: Cache cJSON
      uses: actions/cache@v3
      with:
        path: |
          /usr/local/include/cjson
          /usr/local/lib
        key: ${{ runner.os }}-cjson-${{ hashFiles('cJSON/**') }}
        restore-keys: |
          ${{ runner.os }}-cjson-
    

    - name: Install cJSON
      run: |
        if [ ! -d "cJSON" ]; then
          git clone https://github.com/DaveGamble/cJSON.git
          cd cJSON
          cmake .
          make
          sudo make install
          sudo ldconfig
        fi

    - name: Set LD_LIBRARY_PATH
      run: echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib" >> $GITHUB_ENV

    - name: Compile the project
      run: make

    - name: Run tests
      run: ./bin/SACompiler "utils/Parser/exemples/general/exemple.code" "./test-out.json"
